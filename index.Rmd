---
title: "Corpus Aresh Hemayat"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    css: stotel.css

    
---


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(spotifyr)
library(compmus)
library(unix)
library(plotly)
library(RColorBrewer)
library(ggthemes)
library(viridis)
library(forcats)
library(tidymodels)
library(ggdendro)
library(heatmaply)
library(kknn)
library(grid)
library(gridExtra)
library(ggplot2)
library(Rmisc)
library(audio)


```

<!-- playlists --> 

```{r, include = FALSE}
fruitvale <- get_playlist_audio_features("", "23n37IlJukKL9pUJyBbSib")
creed <- get_playlist_audio_features("", "7jA12g7812CnId8erPPhUo")
everything <- get_playlist_audio_features("", "7AT5LLcwYqISVLfLaaoQQo")
panther <- get_playlist_audio_features("", "0iPhN83fKPIjBpG8vdZfLq")
wish <- get_playlist_audio_features("", "5a9ptUGZg5aZmGqbrgpmbw")
venom <- get_playlist_audio_features("", "5Gtki6gbXEqXY8q0AYo8Ck")
creed2 <- get_playlist_audio_features("", "36L2OTBzMVmY72fLKzSaRo")
slice <- get_playlist_audio_features("", "398opLV7fDeiTRk7d6ulHv")
tenet <- get_playlist_audio_features("", "7EXL4cAtGhd0Qaumzx96rq")
```

<!-- Titles for each scores --> 

```{r, include=FALSE}
scores <-
  bind_rows(
    fruitvale %>% mutate(category = "(2013) Fruitvale Station "),
    creed %>% mutate(category = "(2015) Creed"),
    panther %>% mutate(category = "(2017) Black Panther"),
    wish %>% mutate(category = "(2017) Death Wish "),
    venom %>% mutate(category = "(2018) Venom"),
    creed2 %>% mutate(category = "(2018) Creed II"),
    tenet %>% mutate(category = "(2020) Tenet"),
    slice %>% mutate(category = "(2018) Slice"),
    everything %>% mutate(category = "(2017) Everything, Everything")
  )

```

<!-- Genres --> 

```{r, include=FALSE}
genres <-
  bind_rows(
   
      fruitvale %>% mutate(category = "Drama/Romance"),
    creed %>% mutate(category = "Sport/Drama"),
    panther %>% mutate(category = "Action"),
    wish %>% mutate(category = "Action"),
    venom %>% mutate(category = "Action"),
    creed2 %>% mutate(category = "Sport/Drama"),
    tenet %>% mutate(category = "Action"),
    everything %>% mutate(category = "Drama/Romance")

  )

```

<!-- Summary scores --> 

```{r, include=FALSE}
scores %>%
  summarise(
    mean_speechiness = mean(speechiness),
    mean_acousticness = mean(acousticness),
    mean_liveness = mean(liveness),
    sd_speechiness = sd(speechiness),
    sd_acousticness = sd(acousticness),
    sd_liveness = sd(liveness),
    median_speechiness = median(speechiness),
    median_acousticness = median(acousticness),
    median_liveness = median(liveness),
    mad_speechiness = mad(speechiness),
    mad_acousticness = mad(acousticness),
    mad_liveness = mad(liveness)
  )

```

<!-- Artist features --> 

```{r, include = FALSE}

ludwig <- get_artist_audio_features('Ludwig GÃ¶ransson')

```

<!-- Summary Ludwig --> 

```{r, include=FALSE}
ludwigsum <- ludwig %>%
  summarise(
    mean_speechiness = mean(speechiness),
    mean_acousticness = mean(acousticness),
    mean_liveness = mean(liveness),
    sd_speechiness = sd(speechiness),
    sd_acousticness = sd(acousticness),
    sd_liveness = sd(liveness),
    median_speechiness = median(speechiness),
    median_acousticness = median(acousticness),
    median_liveness = median(liveness),
    mad_speechiness = mad(speechiness),
    mad_acousticness = mad(acousticness),
    mad_liveness = mad(liveness)
  )

```

```{r, include=FALSE}
ludwigsum
```

<!-- classification/clustering  -->
```{r include = FALSE}

library(compmus)

get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}  
```



```{r include = FALSE}


fruitvale <- get_playlist_audio_features("", "23n37IlJukKL9pUJyBbSib")
panther <- get_playlist_audio_features("", "0iPhN83fKPIjBpG8vdZfLq")
creed2 <- get_playlist_audio_features("", "36L2OTBzMVmY72fLKzSaRo")
portfolio <-
  bind_rows(
    fruitvale %>% mutate(playlist = "Fruitvale Station") %>% slice_head(n = 20),
    panther %>% mutate(playlist = "Black Panther") %>% slice_head(n = 20),
    creed2 %>% mutate(playlist = "Creed II") %>% slice_head(n = 20)
  ) 

```

```{r include = FALSE}
portfolio_features <-
  portfolio %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>% 
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))
```


```{r include = FALSE}
indie_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = portfolio_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].
```


```{r include = FALSE}
indie_cv <- portfolio_features %>% vfold_cv(5)
```

```{r include = FALSE}
knn_model <-
  nearest_neighbor(neighbors = 1) %>%
  set_mode("classification") %>% 
  set_engine("kknn")
indie_knn <- 
  workflow() %>% 
  add_recipe(indie_recipe) %>% 
  add_model(knn_model) %>% 
  fit_resamples(
    indie_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```

```{r include = FALSE}
indie_knn %>% get_conf_mat()
```


```{r include = FALSE}
c1 <- indie_knn %>% get_conf_mat() %>% autoplot(type = "mosaic")
```

```{r include = FALSE}
c2 <- indie_knn %>% get_conf_mat() %>% autoplot(type = "heatmap")
```



```{r include = FALSE}
indie_knn %>% get_pr()
```

```{r include = FALSE}
tree_model <-
  decision_tree() %>%
  set_mode("classification") %>% 
  set_engine("C5.0")
indie_tree <- 
  workflow() %>% 
  add_recipe(indie_recipe) %>% 
  add_model(tree_model) %>% 
  fit_resamples(
    indie_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```


```{r include = FALSE}
indie_tree %>% get_pr()
```


```{r include = FALSE}
workflow() %>% 
  add_recipe(indie_recipe) %>% 
  add_model(tree_model) %>% 
  fit(portfolio_features) %>% 
  pluck("fit", "fit", "fit") %>%
  summary()
```


```{r include = FALSE}


forest_model <-
  rand_forest() %>%
  set_mode("classification") %>% 
  set_engine("ranger", importance = "impurity")
indie_forest <- 
  workflow() %>% 
  add_recipe(indie_recipe) %>% 
  add_model(forest_model) %>% 
  fit_resamples(
    indie_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```


```{r include = FALSE}
indie_forest %>% get_pr()
```


```{r include = FALSE}
c5 <- workflow() %>% 
  add_recipe(indie_recipe) %>% 
  add_model(forest_model) %>% 
  fit(portfolio_features) %>% 
  pluck("fit", "fit", "fit") %>%
  ranger::importance() %>% 
  enframe() %>% 
  mutate(name = fct_reorder(name, value)) %>% 
  ggplot(aes(name, value)) + 
  geom_col() + 
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Importance")
```


```{r include = FALSE}
c6 <-portfolio_features %>%
  ggplot(aes(x = c01, y = c02, colour = playlist, size = energy)) +
  geom_point(alpha = 0.8) +
  scale_color_viridis_d() +
  labs(
    x = "Timbre Component 1",
    y = "Timbre Component 2",
    size = "Energy",
    colour = "Playlist"
  )

```
Classification and clustering {.storyboard}
=========================================

### Classification



```{r include = TRUE}

multiplot(c1, c2, cols = 2)

```
***

Test


### Timbre

```{r include = FALSE}
halloween <-
  get_playlist_audio_features("bnfcollection", "1vsoLSK3ArkpaIHmUaF02C") %>%
  add_audio_analysis() %>%
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

```


```{r include = FALSE}
halloween_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = halloween
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors()) %>% 
  # step_range(all_predictors()) %>% 
  prep(halloween %>% mutate(track.name = str_trunc(track.name, 20))) %>%
  juice() %>%
  column_to_rownames("track.name")
```

```{r include = FALSE}
halloween_dist <- dist(halloween_juice, method = "euclidean")
```

```{r include = FALSE}

halloween_dist %>% 
  hclust(method = "single") %>% # Try single, average, and complete.
  dendro_data() %>%
  ggdendrogram()
```


```{r include = FALSE}
 heatmaply(
  halloween_juice,
  hclustfun = hclust,
  hclust_method = "average",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)
```



```{r include = TRUE}

multiplot(c5, c6, cols = 2)

```



<!-- Tempo  -->

Tempo {.storyboard}
=========================================


### Tempogram


```{r, include = FALSE}
wakanda <-
  get_tidy_audio_analysis("0w7yUSxpQV3a3HqlprOQUs") %>%
  select(segments) %>%
  unnest(segments)


```



```{r include = FALSE}
p1 <- wakanda %>%
  mutate(loudness_max_time = start + loudness_max_time) %>%
  arrange(loudness_max_time) %>%
  mutate(delta_loudness = loudness_max - lag(loudness_max)) %>%
  ggplot(aes(x = loudness_max_time, y = pmax(0, delta_loudness))) +
  geom_line() +
  xlim(0, 140) +
  theme_minimal() +
  labs(x = "Time (s)", y = "Novelty")

```


```{r include = FALSE}
p2 <- wakanda %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  arrange(start) %>%
  mutate(pitches = map2(pitches, lag(pitches), `-`)) %>%
  slice(-1) %>%
  compmus_gather_chroma() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = pmax(0, value)
    )
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  xlim(0, 30) +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_classic()
```


```{r include = FALSE}
wakanda2 <- get_tidy_audio_analysis("0w7yUSxpQV3a3HqlprOQUs")
```

```{r include = FALSE}


p3 <- wakanda2 %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  theme_classic()


```

```{r include = TRUE}
a <- p1
b <- p2
c <- p3

grid.newpage()
pushViewport(viewport(layout = grid.layout(2, 2)))
vplayout <- function(x, y) viewport(layout.pos.row = x, layout.pos.col = y)
print(b, vp = vplayout(1, 1))
print(c, vp = vplayout(1, 2))
print(a, vp = vplayout(2, 1:2))

```

```{r include = FALSE}
plots <- list(p1, p2)
```

```{r}

```

***


For tempo i've chosen the song Kilmonger from the Black Panther's score. I think this was an interesting song to analyse because of its different layers it contains. In the beginning you can hear a flute, which represents kilmonger's African background. The flute is pitched down and escalates into chaos. The next layer are the strings and they go up in arpeggios. These escalate and grow bigger. Then suddenly the music cuts out and 808 drums start to kick. It feels dangerous and they come out of nowhere. They have a really low bass and sound like heartbeats. The last layer is the trap beat, representing him coming from Oakland. 

'' note / 
I want to show these layers with lines in the plots and be more specific about what happens with the changes in tempo.  




Analysis {.storyboard}
=========================================
<!-- main 
### Main

```{r, include=FALSE}
lolli <-
  bind_rows(
   
      fruitvale %>% mutate(category = "Drama/Romance"),
    creed2 %>% mutate(category = "Sport/Drama"),
    tenet %>% mutate(category = "Action")
    

  )

```


```{r include = FALSE}
lolli <- lolli %>% mutate(track.name = fct_reorder(track.name, acousticness, last))%>%
ggplot(aes(x = `track.name`, y = `acousticness`, color = track.album.name)) + 
  geom_point(stat='identity', fill="grey", size= 3) +
  scale_size("track.popularity") +
  geom_segment(aes(y = 0.5, 
                   x = `track.name`, 
                   yend = `acousticness`, 
                   xend = `track.name`), 
                   color = "orange",
               alpha = 0.9
               ) +
  geom_text(color="white", size=2, label = "") +
  labs(title="Comparing different scores", 
       subtitle="Ludwig GÃ¶ransson") + 
  ylim(0, 1) +
  coord_flip()+
  scale_color_viridis(alpha = 1, begin = 0.9, end = 0.051, direction = 1,
  discrete = TRUE, option = "inferno") + theme_calc(base_family = "Liberation Serif")



```

```{r include = TRUE}
ggplotly(lolli)
```

***
-->

### Introduction


<!-- First Plot --> 


```{r}
scatter <-scores %>%                    # Start with awards.
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) %>%
  ggplot(                     # Set up the plot.
    aes(
      x = acousticness,
      y = instrumentalness,
      size = loudness,
      colour = mode
    )
  ) +
  geom_point() +              # Scatter plot.
  geom_rug(size = 0.1) +      # Add 'fringes' to show data distribution.
  geom_text(                  # Add text labels from above.
    aes(
      x = acousticness,
      y = instrumentalness,
      label = label,
      color = mode
    ),
    data = 
      tibble(
        label = c("Kilmonger", "RAINY NIGHT IN TALLINN"),
        category = c("(2017) Black Panther", "(2020) Tenet"),
        acousticness = c(0.5230, 0.1090),
        instrumentalness = c(0.932, 0.869000
)
      ),
    colour = "black",         # Override colour (not mode here).
    size = 2.5,                 # Override size (not loudness here).
    hjust = "left",           # Align left side of label with the point.
    vjust = "bottom",         # Align bottom of label with the point.
    nudge_x = -0.05,          # Nudge the label slightly left.
    nudge_y = 0.02            # Nudge the label slightly up.
  ) +
  facet_wrap(~category) +     # Separate charts per playlist.
  scale_x_continuous(         # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),   # Use grid-lines for quadrants only.
    minor_breaks = NULL       # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(         # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(        # Use the Color Brewer to choose a palette.
    type = "qual",            # Qualitative set.
    palette = "Set2"        # Name of the palette is 'Paired'.
  ) +
  scale_size_continuous(      # Fine-tune the sizes of each point.
    trans = "exp",            # Use an exp transformation to emphasise loud.
    guide = "none"            # Remove the legend for size.
  ) +
  theme_light() +             # Use a simpler theme.
  labs(                       # Make the titles nice.
    x = "Acousticness",
    y = "Instrumentalness",
    colour = "Mode"
  ) +
  theme_calc() +
  
  scale_color_viridis(alpha = 1, begin = 0.61, end = 0.3, direction = 1,
  discrete = TRUE, option = "viridis",
)
  



```


```{r}
ggplotly(scatter)
```


***
<h2>Hi there! </h2> For this reasearch I am going to look at film composer and music producer Ludwig Ludwig GÃ¶ransson. In this chart you can see somehow what changes he went trough, from 2013 until 2020. I want to analyse some of his most popular tracks. What made them popular and is there a relation between different popular songs? As you can see Black Panther's has some really interesting findings. For example, "Kilmonger challenge" has one of the highest loudness (as seen in the point size), and "kilmonger" has one of the highest instrumentalness value.  Another interesting finding is the song "Rainy night in Talin" from Tenet. This song has a really high acousticness, high energy and a BPM of 130. 



// notitie

Ik heb het idee van mijn portoflio uitgewerkt in een word documment, maar nog niet in een duidelijke lijn. Ik had in gedachte om nog eventueel het nummer "The Mandalorian" toe te voegen omdat dit zijn meest populaire nummer is. Verder is het duidelijk te zien (op de volgende storyboard) dat er verschillen zijn tussen verschillende genre's. Ik weet alleen nog niet of ik hier verder op in wil gaan, en hoe ik dit dan kan aantonen in de individuele track analyses. Ik denk dat het voor mijn onderzoeksvraag het best is als ik mij richt op de poplariteit en bevindingen in deze chart. 








### Sci-fi or action?

```{r}
scatter2 <-genres %>%                    # Start with awards.
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) %>%
  ggplot(                     # Set up the plot.
    aes(
      x = acousticness,
      y = instrumentalness,
      size = loudness,
      colour = category
    )
  ) +
  geom_point(alpha = 9/10) +              # Scatter plot.
  geom_rug(size = 0.5) +      # Add 'fringes' to show data distribution.
  geom_text(                  # Add text labels from above.
    aes(
      x = acousticness,
      y = instrumentalness,
      label = label,
      color = category
    ),
    data = 
      tibble(
        label = c("", ""),
        category = c("", ""),
        acousticness = c(0.090, 0.123),
        instrumentalness = c(0.101, 0.967)
      ),
    colour = "black",         # Override colour (not mode here).
    size = 3,                 # Override size (not loudness here).
    hjust = "left",           # Align left side of label with the point.
    vjust = "bottom",         # Align bottom of label with the point.
    nudge_x = -0.05,          # Nudge the label slightly left.
    nudge_y = 0.02            # Nudge the label slightly up.
  ) +
  facet_wrap(~mode) +     # Separate charts per playlist.
  scale_x_continuous(         # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),   # Use grid-lines for quadrants only.
    minor_breaks = NULL       # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(         # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(        # Use the Color Brewer to choose a palette.
    type = "qual",            # Qualitative set.
    palette = "Set2"        # Name of the palette is 'Paired'.
  ) +
  scale_size_continuous(      # Fine-tune the sizes of each point.
    trans = "exp",            # Use an exp transformation to emphasise loud.
    guide = "none"            # Remove the legend for size.
  ) +
  theme_light() +             # Use a simpler theme.
  labs(                       # Make the titles nice.
    x = "Acousticness",
    y = "Instrumentalness",
    colour = "Genre"
  ) +
  scale_color_viridis(alpha = 1, begin = 0.9, end = 0.05, direction = 1,
  discrete = TRUE, option = "inferno"
) + theme_calc(base_family = "Liberation Serif")



```


```{r}
ggplotly(scatter2)
```




***

Genres

Chroma {.storyboard}
=========================================

###

```{r}
kilmonger <-
  get_tidy_audio_analysis("0w7yUSxpQV3a3HqlprOQUs") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

```

```{r}
kilmonger %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c() +
  geom_vline(xintercept = 50, linetype="dotted", 
                color = "red", size=1) 
  

```

***
Killmonger

### TENET


###

